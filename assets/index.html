<!doctype html>
<html lang="zh-CN" dir="ltr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>è®¢é˜…ç®¡ç†ä¸­å¿ƒ</title>
		<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
		<style>
			.fade-in {
				animation: fadeIn 0.5s ease-in;
			}
			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}
			.card-hover {
				transition: all 0.3s ease;
			}
			.card-hover:hover {
				transform: translateY(-2px);
			}
			.status-indicator {
				animation: pulse 2s infinite;
			}
			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.7;
				}
			}
		</style>
	</head>

	<body class="bg-gray-50 min-h-screen">
		<!-- Header -->
		<header class="bg-white shadow-sm border-b border-gray-200">
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
				<div class="flex justify-between items-center h-16">
					<div class="flex items-center">
						<i class="fas fa-server text-blue-600 text-2xl mr-3"></i>
						<h1 class="text-xl font-semibold text-gray-900" id="pageTitle">è®¢é˜…ç®¡ç†ä¸­å¿ƒ</h1>
					</div>
					<div class="flex items-center space-x-4">
						<select
							id="languageSelector"
							onchange="changeLanguage(this.value)"
							class="text-sm border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							<option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
							<option value="fa">ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ</option>
						</select>
						<span class="text-sm text-gray-500" id="versionText">Terminal v2.9.2</span>
					</div>
				</div>
			</div>
		</header>

		<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
			<!-- Status Banner -->
			<div id="statusBanner" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 fade-in">
				<div class="flex items-center">
					<i class="fas fa-info-circle text-blue-600 mr-3 status-indicator"></i>
					<div class="text-sm text-blue-800" id="pageSubtitle">å¤šå®¢æˆ·ç«¯æ”¯æŒ â€¢ æ™ºèƒ½ä¼˜é€‰ â€¢ ä¸€é”®ç”Ÿæˆé…ç½®</div>
				</div>
			</div>

			<!-- Client Selection -->
			<div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6 card-hover">
				<div class="flex items-center mb-4">
					<i class="fas fa-users text-blue-600 mr-2"></i>
					<h2 class="text-lg font-semibold text-gray-900" id="clientTitle">é€‰æ‹©å®¢æˆ·ç«¯</h2>
				</div>
				<div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="clientGrid"></div>
				<div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden" id="subUrl">
					<div class="flex items-center justify-between">
						<span class="text-sm font-medium text-gray-700">è®¢é˜…é“¾æ¥:</span>
						<button onclick="copySubUrl()" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-copy mr-1"></i>å¤åˆ¶</button>
					</div>
					<div class="mt-2 p-2 bg-white border border-gray-300 rounded text-xs text-gray-600 break-all font-mono" id="subUrlContent"></div>
				</div>
			</div>

			<!-- System Status -->
			<div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6 card-hover">
				<div class="flex items-center mb-4">
					<i class="fas fa-chart-line text-green-600 mr-2"></i>
					<h2 class="text-lg font-semibold text-gray-900" id="statusTitle">ç³»ç»ŸçŠ¶æ€</h2>
				</div>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="systemStatus">
					<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
						<div class="flex items-center mb-2">
							<i class="fas fa-globe text-blue-500 mr-2"></i>
							<span class="text-sm font-medium text-gray-700">Worker åœ°åŒº</span>
						</div>
						<div class="text-sm font-semibold text-gray-900" id="regionStatus">æ£€æµ‹ä¸­...</div>
					</div>
					<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
						<div class="flex items-center mb-2">
							<i class="fas fa-shield-alt text-green-500 mr-2"></i>
							<span class="text-sm font-medium text-gray-700">æ£€æµ‹æ–¹å¼</span>
						</div>
						<div class="text-sm font-semibold text-gray-900" id="geoInfo">Cloudflareæ£€æµ‹</div>
					</div>
					<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
						<div class="flex items-center mb-2">
							<i class="fas fa-network-wired text-purple-500 mr-2"></i>
							<span class="text-sm font-medium text-gray-700">ProxyIP çŠ¶æ€</span>
						</div>
						<div class="text-sm font-semibold text-green-600" id="proxyIPStatus">âœ… å¯ç”¨</div>
					</div>
					<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
						<div class="flex items-center mb-2">
							<i class="fas fa-wifi text-orange-500 mr-2"></i>
							<span class="text-sm font-medium text-gray-700">å½“å‰ä½¿ç”¨IP</span>
						</div>
						<div class="text-sm font-semibold text-gray-900" id="currentIP">æ™ºèƒ½é€‰æ‹©ä¸­</div>
					</div>
					<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
						<div class="flex items-center mb-2">
							<i class="fas fa-lock text-indigo-500 mr-2"></i>
							<span class="text-sm font-medium text-gray-700">ECH çŠ¶æ€</span>
						</div>
						<div class="text-sm font-semibold text-gray-900" id="echStatus">æ£€æµ‹ä¸­...</div>
					</div>
					<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
						<div class="flex items-center mb-2">
							<i class="fas fa-check-circle text-teal-500 mr-2"></i>
							<span class="text-sm font-medium text-gray-700">åœ°åŒºåŒ¹é…</span>
						</div>
						<div class="text-sm font-semibold text-green-600" id="regionMatch">âœ… åŒ¹é…æˆåŠŸ</div>
					</div>
				</div>
			</div>

			<!-- Token Authentication -->
			<div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6 card-hover" id="tokenCard">
				<div class="flex items-center mb-4">
					<i class="fas fa-key text-amber-600 mr-2"></i>
					<h2 class="text-lg font-semibold text-gray-900" id="tokenTitle">è®¿é—®ä»¤ç‰ŒéªŒè¯</h2>
				</div>
				<div class="space-y-4">
					<div>
						<label class="block text-sm font-medium text-gray-700 mb-2" id="tokenLabel">
							<i class="fas fa-fingerprint mr-1"></i>è®¿é—®ä»¤ç‰Œ
						</label>
						<input
							type="password"
							id="tokenInput"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
							placeholder="è¯·è¾“å…¥ä½ çš„UUIDä»¤ç‰Œ"
						/>
						<p class="mt-1 text-sm text-gray-500" id="tokenHintText">
							<i class="fas fa-info-circle mr-1"></i>
							éœ€è¦æœ‰æ•ˆçš„UUIDä»¤ç‰Œæ‰èƒ½è®¿é—®é…ç½®ç®¡ç†åŠŸèƒ½
						</p>
					</div>
					<div>
						<button
							type="button"
							onclick="validateAndSaveToken()"
							class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
							id="tokenSaveBtn"
						>
							<i class="fas fa-sign-in-alt mr-2"></i>éªŒè¯å¹¶ä¿å­˜
						</button>
					</div>
				</div>
			</div>

			<!-- Configuration Management -->
			<div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6 card-hover" id="configCard">
				<div class="flex items-center mb-4">
					<i class="fas fa-cogs text-indigo-600 mr-2"></i>
					<h2 class="text-lg font-semibold text-gray-900" id="configTitle">é…ç½®ç®¡ç†</h2>
				</div>
				<div id="kvStatus" class="p-4 rounded-lg mb-4"></div>

				<div id="configContent">
					<!-- Region Configuration -->
					<div class="bg-gray-50 rounded-lg p-4 mb-6">
						<h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fas fa-map-marker-alt text-red-500 mr-2"></i>åœ°åŒºé…ç½®</h3>
						<form id="regionForm" class="space-y-4">
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2" id="regionLabel"> æŒ‡å®šåœ°åŒº (wk) </label>
								<select
									id="wkRegion"
									class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
								>
									<option value="">è‡ªåŠ¨æ£€æµ‹</option>
								</select>
							</div>
							<button
								type="submit"
								class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="saveRegionBtn"
							>
								<i class="fas fa-save mr-2"></i>ä¿å­˜åœ°åŒº
							</button>
						</form>
					</div>

					<!-- Protocol Selection -->
					<div class="bg-gray-50 rounded-lg p-4 mb-6">
						<h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fas fa-shield-alt text-blue-500 mr-2"></i>åè®®é€‰æ‹©</h3>
						<div class="space-y-4">
							<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
								<label
									class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors"
								>
									<input type="checkbox" id="ev" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
									<span class="text-sm font-medium text-gray-900">VLESS</span>
								</label>
								<label
									class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors"
								>
									<input type="checkbox" id="et" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
									<span class="text-sm font-medium text-gray-900">Trojan</span>
								</label>
								<label
									class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors"
								>
									<input type="checkbox" id="ex" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
									<span class="text-sm font-medium text-gray-900">xhttp</span>
								</label>
							</div>
							<div class="border-t border-gray-200 pt-4">
								<label
									class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors mb-4"
								>
									<input type="checkbox" id="ech" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
									<span class="text-sm font-medium text-gray-900">ECH (Encrypted Client Hello)</span>
								</label>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2" id="trojanPwdLabel"> Trojan å¯†ç  (å¯é€‰) </label>
									<input
										type="text"
										id="tp"
										class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
										placeholder=""
									/>
								</div>
							</div>
							<button
								type="button"
								onclick="saveProtocolConfig()"
								class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="saveProtocolBtn"
							>
								<i class="fas fa-save mr-2"></i>ä¿å­˜åè®®
							</button>
						</div>
					</div>

					<!-- Basic Configuration -->
					<div class="bg-gray-50 rounded-lg p-4 mb-6">
						<h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fas fa-sliders-h text-green-500 mr-2"></i>åŸºæœ¬é…ç½®</h3>
						<form id="basicConfigForm" class="space-y-4">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2" id="customPathLabel"> è‡ªå®šä¹‰è·¯å¾„ (d) </label>
									<input
										type="text"
										id="customPath"
										class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
										placeholder="/mypath"
									/>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2" id="customIPLabel"> è‡ªå®šä¹‰ ProxyIP (p) </label>
									<input
										type="text"
										id="customIP"
										class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
										placeholder="1.2.3.4:443"
									/>
								</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2" id="yxLabel"> ä¼˜é€‰ IP åˆ—è¡¨ (yx) </label>
								<input
									type="text"
									id="yx"
									class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="1.2.3.4:443#èŠ‚ç‚¹å,5.6.7.8:80"
								/>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2" id="yxURLLabel"> ä¼˜é€‰ IP æ¥æº URL </label>
								<input
									type="text"
									id="yxURL"
									class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder=""
								/>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2" id="socksLabel"> SOCKS5 é…ç½® </label>
								<input
									type="text"
									id="socksConfig"
									class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="user:pass@host:port"
								/>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2" id="homepageLabel"> è‡ªå®šä¹‰é¦–é¡µ URL </label>
								<input
									type="text"
									id="customHomepage"
									class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="https://example.com"
								/>
								<p class="mt-1 text-sm text-gray-500" id="homepageHint">è®¾ç½®è‡ªå®šä¹‰URLä½œä¸ºé¦–é¡µä¼ªè£…</p>
							</div>
							<button
								type="submit"
								class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="saveConfigBtn"
							>
								<i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
							</button>
						</form>
					</div>

					<!-- Advanced Configuration -->
					<div class="bg-gray-50 rounded-lg p-4 mb-6">
						<h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fas fa-cog text-purple-500 mr-2"></i>é«˜çº§æ§åˆ¶</h3>
						<form id="advancedConfigForm" class="space-y-4">
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2" id="scuLabel"> è®¢é˜…è½¬æ¢åœ°å€ </label>
								<input
									type="text"
									id="scu"
									class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="https://url.v1.mk/sub"
								/>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-3">ä¼˜åŒ–é€‰é¡¹</label>
								<div class="space-y-2">
									<label
										class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors"
									>
										<input type="checkbox" id="epd" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
										<span class="text-sm font-medium text-gray-900" id="epdLabel">å¯ç”¨ä¼˜é€‰åŸŸå</span>
									</label>
									<label
										class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors"
									>
										<input type="checkbox" id="epi" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
										<span class="text-sm font-medium text-gray-900" id="epiLabel">å¯ç”¨ä¼˜é€‰IP</span>
									</label>
									<label
										class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors"
									>
										<input type="checkbox" id="egi" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
										<span class="text-sm font-medium text-gray-900" id="egiLabel">å¯ç”¨GitHubä¼˜é€‰</span>
									</label>
								</div>
							</div>
							<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2" id="aeLabel"> API ç®¡ç† </label>
									<select
										id="apiEnabled"
										class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									>
										<option value="">é»˜è®¤ï¼ˆå…³é—­ï¼‰</option>
										<option value="yes">å¼€å¯</option>
									</select>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2" id="rmLabel"> åœ°åŒºåŒ¹é… </label>
									<select
										id="regionMatching"
										class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									>
										<option value="">é»˜è®¤ï¼ˆå¯ç”¨ï¼‰</option>
										<option value="no">å…³é—­</option>
									</select>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2" id="dkbyLabel"> TLS æ§åˆ¶ </label>
									<select
										id="portControl"
										class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									>
										<option value="">é»˜è®¤ï¼ˆå…¨éƒ¨ï¼‰</option>
										<option value="yes">ä»…TLS</option>
									</select>
								</div>
							</div>
							<button
								type="submit"
								class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="saveAdvancedBtn"
							>
								<i class="fas fa-save mr-2"></i>ä¿å­˜é«˜çº§é…ç½®
							</button>
						</form>
					</div>

					<!-- Current Configuration Display -->
					<div class="bg-gray-50 rounded-lg p-4 mb-6">
						<h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fas fa-clipboard-list text-orange-500 mr-2"></i>å½“å‰é…ç½®</h3>
						<div
							id="currentConfig"
							class="p-4 bg-white rounded-lg border border-gray-200 font-mono text-sm text-gray-700 whitespace-pre-wrap"
						></div>
						<div class="mt-4 flex flex-wrap gap-2">
							<button
								onclick="loadCurrentConfig()"
								class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="refreshBtn"
							>
								<i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
							</button>
							<button
								onclick="resetAllConfig()"
								class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="resetBtn"
							>
								<i class="fas fa-undo mr-2"></i>é‡ç½®
							</button>
						</div>
					</div>

					<!-- Domain Management -->
					<div class="bg-gray-50 rounded-lg p-4 mb-6">
						<h3 class="text-md font-semibold text-gray-900 mb-2"><i class="fas fa-globe-americas text-teal-500 mr-2"></i>ä¼˜é€‰åŸŸåç®¡ç†</h3>
						<p class="text-sm text-gray-600 mb-4" id="domainsHint">ç®¡ç†è®¢é˜…ä¸­ä½¿ç”¨çš„ä¼˜é€‰åŸŸååˆ—è¡¨ã€‚éœ€å…ˆå¼€å¯"å…è®¸APIç®¡ç†"é€‰é¡¹ã€‚</p>

						<!-- Domains Table -->
						<div class="bg-white rounded-lg border border-gray-200 overflow-hidden mb-4">
							<div class="overflow-x-auto">
								<table class="min-w-full divide-y divide-gray-200">
									<thead class="bg-gray-50">
										<tr>
											<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="domainCol">åŸŸå</th>
											<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="nameCol">åç§°</th>
											<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" id="portCol">ç«¯å£</th>
											<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" id="typeCol">ç±»å‹</th>
											<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" id="actionCol">æ“ä½œ</th>
										</tr>
									</thead>
									<tbody id="domainsTbody" class="bg-white divide-y divide-gray-200">
										<tr>
											<td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500">
												<i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½ä¸­...
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>

						<!-- Add New Domain -->
						<div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
							<h4 class="text-sm font-medium text-gray-900 mb-3">æ·»åŠ æ–°åŸŸå</h4>
							<div class="flex flex-col sm:flex-row gap-3">
								<input
									type="text"
									id="newDomain"
									class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="example.com"
								/>
								<input
									type="text"
									id="newDomainName"
									class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="èŠ‚ç‚¹åç§°"
								/>
                                <input
									type="text"
									id="newAddonWsArgs"
									class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="é¢å¤–wså‚æ•°"
								/>
								<input
									type="number"
									id="newDomainPort"
									class="w-24 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
									placeholder="443"
									value="443"
								/>
								<button
									type="button"
									onclick="addDomain()"
									class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors whitespace-nowrap"
									id="addDomainBtn"
								>
									<i class="fas fa-plus mr-2"></i>æ·»åŠ 
								</button>
							</div>
						</div>

						<div class="flex flex-wrap gap-2">
							<button
								onclick="loadDomains()"
								class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="refreshDomainsBtn"
							>
								<i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°åˆ—è¡¨
							</button>
							<button
								onclick="clearCustomDomains()"
								class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
								id="clearDomainsBtn"
							>
								<i class="fas fa-trash-alt mr-2"></i>æ¸…ç©ºè‡ªå®šä¹‰
							</button>
						</div>
					</div>
				</div>
				<div id="statusMessage" class="fixed top-20 right-4 z-50 hidden px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full"></div>
			</div>

			<!-- Related Links -->
			<div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 card-hover">
				<div class="flex items-center mb-4">
					<i class="fas fa-link text-gray-600 mr-2"></i>
					<h2 class="text-lg font-semibold text-gray-900" id="linksTitle">ç›¸å…³é“¾æ¥</h2>
				</div>
				<div class="flex flex-col sm:flex-row gap-4">
					<a
						href="https://github.com/denislov/cfterm"
						target="_blank"
						class="flex items-center text-gray-600 hover:text-blue-600 transition-colors"
						id="githubLink"
					>
						<i class="fab fa-github mr-2"></i>
						<span>GitHub é¡¹ç›®</span>
					</a>
					<a
						href="https://www.youtube.com/@denislov-f9b"
						target="_blank"
						class="flex items-center text-gray-600 hover:text-red-600 transition-colors"
					>
						<i class="fab fa-youtube mr-2"></i>
						<span>YouTube @denislov</span>
					</a>
				</div>
			</div>
		</main>

		<script>
			// å¤šè¯­è¨€ç¿»è¯‘é…ç½®
			const i18n = {
				zh: {
					title: 'è®¢é˜…ä¸­å¿ƒ',
					subtitle: 'å¤šå®¢æˆ·ç«¯æ”¯æŒ â€¢ æ™ºèƒ½ä¼˜é€‰ â€¢ ä¸€é”®ç”Ÿæˆ',
					clientTitle: '[ é€‰æ‹©å®¢æˆ·ç«¯ ]',
					statusTitle: '[ ç³»ç»ŸçŠ¶æ€ ]',
					configTitle: '[ é…ç½®ç®¡ç† ]',
					linksTitle: '[ ç›¸å…³é“¾æ¥ ]',
					version: 'ç»ˆç«¯ v2.9.2',
					githubLink: 'GitHub é¡¹ç›®',
					regionLabel: 'æŒ‡å®šåœ°åŒº (wk):',
					autoDetect: 'è‡ªåŠ¨æ£€æµ‹',
					saveRegion: 'ä¿å­˜åœ°åŒº',
					protocolLabel: 'åè®®é€‰æ‹©:',
					trojanPwdLabel: 'Trojan å¯†ç  (å¯é€‰):',
					saveProtocol: 'ä¿å­˜åè®®',
					customPathLabel: 'è‡ªå®šä¹‰è·¯å¾„ (d):',
					customIPLabel: 'è‡ªå®šä¹‰ProxyIP (p):',
					yxLabel: 'ä¼˜é€‰IPåˆ—è¡¨ (yx):',
					yxURLLabel: 'ä¼˜é€‰IPæ¥æºURL:',
					socksLabel: 'SOCKS5é…ç½®:',
					homepageLabel: 'è‡ªå®šä¹‰é¦–é¡µURL:',
					homepageHint: 'è®¾ç½®è‡ªå®šä¹‰URLä½œä¸ºé¦–é¡µä¼ªè£…',
					saveConfig: 'ä¿å­˜é…ç½®',
					advancedTitle: 'é«˜çº§æ§åˆ¶',
					scuLabel: 'è®¢é˜…è½¬æ¢åœ°å€:',
					epdLabel: 'å¯ç”¨ä¼˜é€‰åŸŸå',
					epiLabel: 'å¯ç”¨ä¼˜é€‰IP',
					egiLabel: 'å¯ç”¨GitHubä¼˜é€‰',
					aeLabel: 'APIç®¡ç†:',
					aeDefault: 'é»˜è®¤ï¼ˆå…³é—­ï¼‰',
					aeYes: 'å¼€å¯',
					rmLabel: 'åœ°åŒºåŒ¹é…:',
					rmDefault: 'é»˜è®¤ï¼ˆå¯ç”¨ï¼‰',
					rmNo: 'å…³é—­',
					dkbyLabel: 'TLSæ§åˆ¶:',
					dkbyDefault: 'é»˜è®¤ï¼ˆå…¨éƒ¨ï¼‰',
					dkbyYes: 'ä»…TLS',
					saveAdvanced: 'ä¿å­˜é«˜çº§é…ç½®',
					refresh: 'åˆ·æ–°',
					reset: 'é‡ç½®',
					checking: 'æ£€æµ‹ä¸­...',
					workerRegion: 'Workeråœ°åŒº: ',
					detectionMethod: 'æ£€æµ‹æ–¹å¼: ',
					proxyIPStatus: 'ProxyIPçŠ¶æ€: ',
					currentIP: 'å½“å‰ä½¿ç”¨IP: ',
					regionMatch: 'åœ°åŒºåŒ¹é…: ',
					kvEnabled: 'âœ… KVå­˜å‚¨å·²å¯ç”¨',
					kvDisabled: 'âš ï¸ KVå­˜å‚¨æœªé…ç½®',
					subCopied: 'è®¢é˜…é“¾æ¥å·²å¤åˆ¶',
					loading: 'åŠ è½½ä¸­...',
					regions: {
						US: 'ğŸ‡ºğŸ‡¸ ç¾å›½',
						SG: 'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡',
						JP: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬',
						KR: 'ğŸ‡°ğŸ‡· éŸ©å›½',
						DE: 'ğŸ‡©ğŸ‡ª å¾·å›½',
						SE: 'ğŸ‡¸ğŸ‡ª ç‘å…¸',
						NL: 'ğŸ‡³ğŸ‡± è·å…°',
						FI: 'ğŸ‡«ğŸ‡® èŠ¬å…°',
						GB: 'ğŸ‡¬ğŸ‡§ è‹±å›½',
					},
					cloudflareDetection: 'Cloudflareæ£€æµ‹',
					available: 'å¯ç”¨',
					smartSelection: 'æ™ºèƒ½é€‰æ‹©ä¸­',
					tokenLabel: 'è®¿é—®ä»¤ç‰Œ:',
					tokenPlaceholder: 'è¯·è¾“å…¥ä½ çš„UUIDä»¤ç‰Œ',
					tokenHint: 'éœ€è¦æœ‰æ•ˆçš„UUIDä»¤ç‰Œæ‰èƒ½è®¿é—®é…ç½®ç®¡ç†åŠŸèƒ½',
					tokenSave: 'éªŒè¯å¹¶ä¿å­˜',
					tokenRequired: 'è¯·å…ˆè¾“å…¥è®¿é—®ä»¤ç‰Œ',
					tokenInvalid: 'ä»¤ç‰ŒéªŒè¯å¤±è´¥',
				},
				fa: {
					title: 'Ù…Ø±Ú©Ø² Ø§Ø´ØªØ±Ø§Ú©',
					subtitle: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú†Ù†Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª â€¢ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯',
					clientTitle: '[ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§ÛŒÙ†Øª ]',
					statusTitle: '[ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ… ]',
					configTitle: '[ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª ]',
					linksTitle: '[ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ ]',
					version: 'ØªØ±Ù…ÛŒÙ†Ø§Ù„ v2.9.2',
					githubLink: 'Ù¾Ø±ÙˆÚ˜Ù‡ GitHub',
					regionLabel: 'ØªØ¹ÛŒÛŒÙ† Ù…Ù†Ø·Ù‚Ù‡:',
					autoDetect: 'ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±',
					saveRegion: 'Ø°Ø®ÛŒØ±Ù‡',
					protocolLabel: 'Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆØªÚ©Ù„:',
					trojanPwdLabel: 'Ø±Ù…Ø² Trojan:',
					saveProtocol: 'Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆØªÚ©Ù„',
					customPathLabel: 'Ù…Ø³ÛŒØ± Ø³ÙØ§Ø±Ø´ÛŒ:',
					customIPLabel: 'ProxyIP Ø³ÙØ§Ø±Ø´ÛŒ:',
					yxLabel: 'Ù„ÛŒØ³Øª IP ØªØ±Ø¬ÛŒØ­ÛŒ:',
					yxURLLabel: 'URL Ù…Ù†Ø¨Ø¹ IP:',
					socksLabel: 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª SOCKS5:',
					homepageLabel: 'URL ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ:',
					homepageHint: 'ØªÙ†Ø¸ÛŒÙ… URL Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØªØ§Ø±',
					saveConfig: 'Ø°Ø®ÛŒØ±Ù‡',
					advancedTitle: 'Ú©Ù†ØªØ±Ù„ Ù¾ÛŒØ´Ø±ÙØªÙ‡',
					scuLabel: 'Ø¢Ø¯Ø±Ø³ ØªØ¨Ø¯ÛŒÙ„:',
					epdLabel: 'Ø¯Ø§Ù…Ù†Ù‡ ØªØ±Ø¬ÛŒØ­ÛŒ',
					epiLabel: 'IP ØªØ±Ø¬ÛŒØ­ÛŒ',
					egiLabel: 'GitHub ØªØ±Ø¬ÛŒØ­ÛŒ',
					aeLabel: 'Ù…Ø¯ÛŒØ±ÛŒØª API:',
					aeDefault: 'Ù¾ÛŒØ´â€ŒÙØ±Ø¶',
					aeYes: 'ÙØ¹Ø§Ù„',
					rmLabel: 'ØªØ·Ø¨ÛŒÙ‚ Ù…Ù†Ø·Ù‚Ù‡:',
					rmDefault: 'Ù¾ÛŒØ´â€ŒÙØ±Ø¶',
					rmNo: 'ØºÛŒØ±ÙØ¹Ø§Ù„',
					dkbyLabel: 'Ú©Ù†ØªØ±Ù„ TLS:',
					dkbyDefault: 'Ù‡Ù…Ù‡',
					dkbyYes: 'ÙÙ‚Ø· TLS',
					saveAdvanced: 'Ø°Ø®ÛŒØ±Ù‡',
					refresh: 'ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ',
					reset: 'Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ',
					checking: 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...',
					workerRegion: 'Ù…Ù†Ø·Ù‚Ù‡: ',
					detectionMethod: 'Ø±ÙˆØ´: ',
					proxyIPStatus: 'ÙˆØ¶Ø¹ÛŒØª ProxyIP: ',
					currentIP: 'IP ÙØ¹Ù„ÛŒ: ',
					regionMatch: 'ØªØ·Ø¨ÛŒÙ‚: ',
					kvEnabled: 'âœ… KV ÙØ¹Ø§Ù„',
					kvDisabled: 'âš ï¸ KV ØºÛŒØ±ÙØ¹Ø§Ù„',
					subCopied: 'Ú©Ù¾ÛŒ Ø´Ø¯',
					loading: 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...',
					regions: {
						US: 'ğŸ‡ºğŸ‡¸ Ø¢Ù…Ø±ÛŒÚ©Ø§',
						SG: 'ğŸ‡¸ğŸ‡¬ Ø³Ù†Ú¯Ø§Ù¾ÙˆØ±',
						JP: 'ğŸ‡¯ğŸ‡µ Ú˜Ø§Ù¾Ù†',
						KR: 'ğŸ‡°ğŸ‡· Ú©Ø±Ù‡',
						DE: 'ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù†',
						SE: 'ğŸ‡¸ğŸ‡ª Ø³ÙˆØ¦Ø¯',
						NL: 'ğŸ‡³ğŸ‡± Ù‡Ù„Ù†Ø¯',
						FI: 'ğŸ‡«ğŸ‡® ÙÙ†Ù„Ø§Ù†Ø¯',
						GB: 'ğŸ‡¬ğŸ‡§ Ø¨Ø±ÛŒØªØ§Ù†ÛŒØ§',
					},
					cloudflareDetection: 'ØªØ´Ø®ÛŒØµ Cloudflare',
					available: 'Ø¯Ø± Ø¯Ø³ØªØ±Ø³',
					smartSelection: 'Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯',
					tokenLabel: 'ØªÙˆÚ©Ù† Ø¯Ø³ØªØ±Ø³ÛŒ:',
					tokenPlaceholder: 'ØªÙˆÚ©Ù† UUID Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯',
					tokenHint: 'Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ ØªÙˆÚ©Ù† UUID Ù…Ø¹ØªØ¨Ø± Ù„Ø§Ø²Ù… Ø§Ø³Øª',
					tokenSave: 'ØªØ£ÛŒÛŒØ¯',
					tokenRequired: 'Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯',
					tokenInvalid: 'ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª',
				},
			};

			const clients = [
				{ type: 'clash', name: 'CLASH', scheme: 'clash://install-config?url=' },
				{ type: 'clash', name: 'STASH', scheme: 'stash://install?url=' },
				{ type: 'surge', name: 'SURGE', scheme: 'surge:///install-config?url=' },
				{ type: 'singbox', name: 'SING-BOX', scheme: 'sing-box://install-config?url=' },
				{ type: 'loon', name: 'LOON', scheme: 'loon://install?url=' },
				{ type: 'quanx', name: 'QUANTUMULT X', scheme: 'quantumult-x://install-config?url=' },
				{ type: 'v2ray', name: 'V2RAY', scheme: '' },
				{ type: 'v2ray', name: 'Shadowrocket', scheme: 'shadowrocket://add/' },
			];

			let currentLang = 'zh';
			let t = i18n.zh;
			const API_BASE = window.location.origin;
			const SUB_CONVERTER = 'https://url.v1.mk/sub';

			// Token ç®¡ç†
			let AUTH_TOKEN = localStorage.getItem('authToken') || '';

			// å¸¦è®¤è¯çš„ fetch å°è£…
			async function authFetch(url, options = {}) {
				const headers = {
					...options.headers,
				};
				if (AUTH_TOKEN) {
					headers['X-Token'] = AUTH_TOKEN;
				}
				return fetch(url, { ...options, headers });
			}

			// éªŒè¯å¹¶ä¿å­˜ Token
			async function validateAndSaveToken() {
				const tokenInput = document.getElementById('tokenInput');
				const token = tokenInput.value.trim();

				if (!token) {
					showStatus(t.tokenRequired, 'error');
					return;
				}

				// ä¸´æ—¶è®¾ç½® token å¹¶æµ‹è¯•
				AUTH_TOKEN = token;
				try {
					const res = await authFetch(`${API_BASE}/api/config`);
					if (res.ok || res.status === 503) {
						// 503 è¡¨ç¤º KV æœªé…ç½®ï¼Œä½†è®¤è¯æˆåŠŸ
						localStorage.setItem('authToken', token);
						showStatus('Token éªŒè¯æˆåŠŸ', 'success');
						document.getElementById('tokenCard').style.display = 'none';
						checkKVStatus();
						loadDomains();
					} else if (res.status === 401 || res.status === 403) {
						AUTH_TOKEN = '';
						showStatus(t.tokenInvalid, 'error');
					} else {
						const data = await res.json();
						showStatus(data.error || t.tokenInvalid, 'error');
					}
				} catch (e) {
					AUTH_TOKEN = '';
					showStatus('éªŒè¯å¤±è´¥: ' + e.message, 'error');
				}
			}

			// å·¥å…·å‡½æ•°
			function getCookie(name) {
				const v = '; ' + document.cookie;
				const p = v.split('; ' + name + '=');
				return p.length === 2 ? p.pop().split(';').shift() : null;
			}
			function setCookie(name, value) {
				const d = new Date();
				d.setFullYear(d.getFullYear() + 1);
				document.cookie = `${name}=${value}; path=/; expires=${d.toUTCString()}; SameSite=Lax`;
			}
			function detectLanguage() {
				const saved = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
				if (saved === 'fa' || saved === 'fa-IR') return 'fa';
				if (saved === 'zh' || saved === 'zh-CN') return 'zh';
				return navigator.language?.includes('fa') ? 'fa' : 'zh';
			}
			function changeLanguage(lang) {
				localStorage.setItem('preferredLanguage', lang);
				setCookie('preferredLanguage', lang);
				location.reload();
			}

			// åº”ç”¨è¯­è¨€
			function applyLanguage(lang) {
				currentLang = lang;
				t = i18n[lang];
				document.documentElement.lang = lang === 'fa' ? 'fa-IR' : 'zh-CN';
				document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
				document.title = t.title;

				// æ›´æ–°UIæ–‡æœ¬
				document.getElementById('versionText').textContent = t.version;
				document.getElementById('pageTitle').textContent = t.title;
				document.getElementById('pageSubtitle').textContent = t.subtitle;
				document.getElementById('clientTitle').textContent = t.clientTitle;
				document.getElementById('statusTitle').textContent = t.statusTitle;
				document.getElementById('configTitle').textContent = t.configTitle;
				document.getElementById('linksTitle').textContent = t.linksTitle;
				document.getElementById('githubLink').textContent = t.githubLink;
				document.getElementById('regionLabel').textContent = t.regionLabel;
				document.getElementById('saveRegionBtn').textContent = t.saveRegion;
				// document.getElementById('protocolLabel').textContent = t.protocolLabel;
				document.getElementById('trojanPwdLabel').textContent = t.trojanPwdLabel;
				document.getElementById('saveProtocolBtn').textContent = t.saveProtocol;
				document.getElementById('customPathLabel').textContent = t.customPathLabel;
				document.getElementById('customIPLabel').textContent = t.customIPLabel;
				document.getElementById('yxLabel').textContent = t.yxLabel;
				document.getElementById('yxURLLabel').textContent = t.yxURLLabel;
				document.getElementById('socksLabel').textContent = t.socksLabel;
				document.getElementById('homepageLabel').textContent = t.homepageLabel;
				document.getElementById('homepageHint').textContent = t.homepageHint;
				document.getElementById('saveConfigBtn').textContent = t.saveConfig;
				// document.getElementById('advancedTitle').textContent = t.advancedTitle;
				document.getElementById('scuLabel').textContent = t.scuLabel;
				document.getElementById('epdLabel').textContent = t.epdLabel;
				document.getElementById('epiLabel').textContent = t.epiLabel;
				document.getElementById('egiLabel').textContent = t.egiLabel;
				document.getElementById('aeLabel').textContent = t.aeLabel;
				document.getElementById('rmLabel').textContent = t.rmLabel;
				document.getElementById('dkbyLabel').textContent = t.dkbyLabel;
				document.getElementById('saveAdvancedBtn').textContent = t.saveAdvanced;
				document.getElementById('refreshBtn').textContent = t.refresh;
				document.getElementById('resetBtn').textContent = t.reset;
				document.getElementById('languageSelector').value = lang;

				// æ¸²æŸ“å®¢æˆ·ç«¯æŒ‰é’®
				renderClientButtons();
				// æ¸²æŸ“åœ°åŒºé€‰æ‹©
				renderRegionSelect();
				// æ¸²æŸ“é«˜çº§é€‰æ‹©æ¡†
				renderAdvancedSelects();
			}

			function renderClientButtons() {
				const grid = document.getElementById('clientGrid');
				grid.innerHTML = clients
					.map(
						(c) =>
							`<button onclick="generateLink('${c.type}','${c.name}','${c.scheme}')" 
                        class="flex flex-col items-center justify-center p-4 bg-white border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors cursor-pointer">
                    <i class="fas fa-rocket text-2xl mb-2 ${getClientColor(c.name)}"></i>
                    <span class="text-sm font-medium text-gray-900">${c.name}</span>
                </button>`,
					)
					.join('');
			}

			function getClientColor(name) {
				const colors = {
					CLASH: 'text-blue-600',
					STASH: 'text-purple-600',
					SURGE: 'text-orange-600',
					'SING-BOX': 'text-green-600',
					LOON: 'text-red-600',
					'QUANTUMULT X': 'text-indigo-600',
					V2RAY: 'text-gray-600',
					Shadowrocket: 'text-yellow-600',
				};
				return colors[name] || 'text-gray-600';
			}

			function renderRegionSelect() {
				const sel = document.getElementById('wkRegion');
				sel.innerHTML =
					`<option value="">${t.autoDetect}</option>` +
					Object.entries(t.regions)
						.map(([k, v]) => `<option value="${k}">${v}</option>`)
						.join('');
			}

			function renderAdvancedSelects() {
				document.getElementById('apiEnabled').innerHTML = `<option value="">${t.aeDefault}</option><option value="yes">${t.aeYes}</option>`;
				document.getElementById('regionMatching').innerHTML =
					`<option value="">${t.rmDefault}</option><option value="no">${t.rmNo}</option>`;
				document.getElementById('portControl').innerHTML =
					`<option value="">${t.dkbyDefault}</option><option value="yes">${t.dkbyYes}</option>`;
			}

			// ç”Ÿæˆè®¢é˜…é“¾æ¥
			function generateLink(type, name, scheme) {
				const subUrl = location.href.replace(/\/$/, '') + '/sub';
				let finalUrl = subUrl;

				if (type !== 'v2ray') {
					const encoded = encodeURIComponent(subUrl);
					finalUrl = `${SUB_CONVERTER}?target=${type}&url=${encoded}&insert=false&emoji=true&list=false&expand=true&scv=false&new_name=true`;
				}

				const urlEl = document.getElementById('subUrl');
				const urlContentEl = document.getElementById('subUrlContent');
				urlContentEl.textContent = finalUrl;
				urlEl.classList.remove('hidden');
				urlEl.classList.add('fade-in');

				if (scheme) {
					const schemeUrl = scheme + encodeURIComponent(finalUrl);
					const iframe = document.createElement('iframe');
					iframe.style.display = 'none';
					iframe.src = schemeUrl;
					document.body.appendChild(iframe);
					setTimeout(() => iframe.remove(), 2000);
				}

				navigator.clipboard.writeText(finalUrl).then(() => {
					showStatus(`${name} è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');
				});
			}

			// å¤åˆ¶è®¢é˜…é“¾æ¥
			function copySubUrl() {
				const urlContent = document.getElementById('subUrlContent').textContent;
				navigator.clipboard.writeText(urlContent).then(() => {
					showStatus('è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
				});
			}

			// çŠ¶æ€æ£€æµ‹
			async function checkSystemStatus() {
				try {
					const res = await fetch(`${API_BASE}/api/status`);
					const data = await res.json();

					document.getElementById('regionStatus').innerHTML =
						`<span class="text-green-600">ğŸŒ ${t.regions[data.region] || data.region}</span>`;
					document.getElementById('geoInfo').innerHTML = `<span class="text-blue-600">ğŸ” ${t.cloudflareDetection}</span>`;
					document.getElementById('proxyIPStatus').innerHTML = `<span class="text-green-600">âœ… ${t.available}</span>`;
					document.getElementById('currentIP').innerHTML = `<span class="text-gray-600">ğŸ”„ ${t.smartSelection}</span>`;
					document.getElementById('regionMatch').innerHTML = `<span class="text-green-600">âœ… åŒ¹é…æˆåŠŸ</span>`;

					if (data.echEnabled) {
						document.getElementById('echStatus').innerHTML = `<span class="text-green-600">âœ… ${t.available}</span>`;
					} else {
						document.getElementById('echStatus').innerHTML = `<span class="text-amber-600">âš ï¸ æœªå¯ç”¨</span>`;
					}
				} catch (e) {
					// å›é€€åˆ°regionç«¯ç‚¹
					try {
						const res = await fetch(`${API_BASE}/region`);
						const data = await res.json();
						document.getElementById('regionStatus').innerHTML =
							`<span class="text-green-600">ğŸŒ ${t.regions[data.region] || data.region}</span>`;
						document.getElementById('geoInfo').innerHTML =
							`<span class="text-blue-600">ğŸ” ${data.detectionMethod || t.cloudflareDetection}</span>`;
					} catch (e2) {
						document.getElementById('regionStatus').innerHTML = `<span class="text-red-600">âŒ è·å–å¤±è´¥</span>`;
					}
				}
			}

			// KVé…ç½®æ£€æµ‹
			async function checkKVStatus() {
				// å¦‚æœæ²¡æœ‰ tokenï¼Œæ˜¾ç¤º token è¾“å…¥å¡ç‰‡
				if (!AUTH_TOKEN) {
					document.getElementById('tokenCard').classList.remove('hidden');
					document.getElementById('configCard').classList.add('hidden');
					return;
				}

				try {
					const res = await authFetch(`${API_BASE}/api/config`);
                    console.log(res.status)
					// è®¤è¯å¤±è´¥
					if (res.status === 401 || res.status === 403) {
						AUTH_TOKEN = '';
						localStorage.removeItem('authToken');
						document.getElementById('tokenCard').classList.remove('hidden');
						document.getElementById('configCard').classList.add('hidden');
						return;
					}

					// éšè— token å¡ç‰‡
					document.getElementById('tokenCard').classList.add('hidden');

					if (res.status === 503) {
						const statusEl = document.getElementById('kvStatus');
						statusEl.innerHTML = `<div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>
                        <span class="text-amber-800">${t.kvDisabled}</span>
                    </div>`;
						statusEl.className = 'bg-amber-50 border border-amber-200 text-amber-800 p-3 rounded-lg';
						document.getElementById('configCard').classList.remove('hidden');
						return;
					}
					const data = await res.json();
                    console.log(data)
					if (data.kvEnabled) {
						const statusEl = document.getElementById('kvStatus');
						statusEl.innerHTML = `<div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-green-800">${t.kvEnabled}</span>
                    </div>`;
						statusEl.className = 'bg-green-50 border border-green-200 text-green-800 p-3 rounded-lg';
						document.getElementById('configContent').classList.remove('hidden');
						document.getElementById('configCard').classList.remove('hidden');
						loadCurrentConfig();
					} else {
						const statusEl = document.getElementById('kvStatus');
						statusEl.innerHTML = `<div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>
                        <span class="text-amber-800">${t.kvDisabled}</span>
                    </div>`;
						statusEl.className = 'bg-amber-50 border border-amber-200 text-amber-800 p-3 rounded-lg';
						document.getElementById('configCard').classList.remove('hidden');
					}
				} catch (e) {
					const statusEl = document.getElementById('kvStatus');
					statusEl.innerHTML = `<div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>
                    <span class="text-amber-800">${t.kvDisabled}</span>
                </div>`;
					statusEl.className = 'bg-amber-50 border border-amber-200 text-amber-800 p-3 rounded-lg';
					document.getElementById('configCard').classList.remove('hidden');
				}
			}

			// åŠ è½½å½“å‰é…ç½®
			async function loadCurrentConfig() {
				try {
					const res = await authFetch(`${API_BASE}/api/config`);
					if (!res.ok) return;
					const cfg = await res.json();
                    console.log("cfg:",cfg)

					// å¡«å……è¡¨å•
					document.getElementById('wkRegion').value = cfg.wk || '';
					document.getElementById('ev').checked = cfg.ev !== false;
					document.getElementById('et').checked = cfg.et === true;
					document.getElementById('ex').checked = cfg.ex === true;
					document.getElementById('ech').checked = cfg.ech === true;
					document.getElementById('tp').value = cfg.tp || '';
					document.getElementById('customPath').value = cfg.d || '';
					document.getElementById('customIP').value = cfg.p || '';
					document.getElementById('yx').value = cfg.yx || '';
					document.getElementById('yxURL').value = cfg.yxURL || '';
					document.getElementById('socksConfig').value = cfg.s || '';
					document.getElementById('customHomepage').value = cfg.homepage || '';
					document.getElementById('scu').value = cfg.scu || '';
					document.getElementById('epd').checked = cfg.epd === true;
					document.getElementById('epi').checked = cfg.epi !== false;
					document.getElementById('egi').checked = cfg.egi !== false;
					document.getElementById('apiEnabled').value = cfg.ae ? '':"no";
					document.getElementById('regionMatching').value = cfg.rm || '';
					document.getElementById('portControl').value = cfg.dkby ? 'yes':'';

					// æ˜¾ç¤ºå½“å‰é…ç½®
					const display = Object.entries(cfg)
						.filter(([k]) => k !== 'kvEnabled')
						.map(([k, v]) => `${k}: ${v}`)
						.join('\n');
					document.getElementById('currentConfig').textContent = display || '(æ— é…ç½®)';
				} catch (e) {
					document.getElementById('currentConfig').textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
				}
			}

			// ä¿å­˜é…ç½®
			async function saveConfig(data) {
				try {
					const res = await authFetch(`${API_BASE}/api/config`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(data),
					});
					const result = await res.json();
					showStatus(result.message || 'ä¿å­˜æˆåŠŸ', result.success ? 'success' : 'error');
					if (result.success) {
						loadCurrentConfig();
						setTimeout(() => location.reload(), 1500);
					}
				} catch (e) {
					showStatus('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
				}
			}

			// é‡ç½®é…ç½®
			async function resetAllConfig() {
				if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ')) return;
				await saveConfig({
					wk: '',
					d: '',
					p: '',
					yx: '',
					yxURL: '',
					s: '',
					ae: '',
					rm: '',
					dkby: '',
					ev: '',
					et: '',
					ex: '',
					tp: '',
					scu: '',
					epd: '',
					epi: '',
					egi: '',
					homepage: '',
				});
			}

		// æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
		function showStatus(msg, type) {
			const el = document.getElementById('statusMessage');
			el.textContent = msg;
			el.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800', 'translate-x-full');

			if (type === 'success') {
				el.classList.add('bg-green-100', 'text-green-800', 'border-l-4', 'border-green-500');
			} else {
				el.classList.add('bg-red-100', 'text-red-800', 'border-l-4', 'border-red-500');
			}

			// è§¦å‘æ»‘å…¥åŠ¨ç”»
			setTimeout(() => {
				el.classList.remove('translate-x-full');
				el.classList.add('translate-x-0');
			}, 10);

			// 1ç§’åè‡ªåŠ¨æ¶ˆå¤±
			setTimeout(() => {
				el.classList.add('translate-x-full');
				el.classList.remove('translate-x-0');
				setTimeout(() => {
					el.classList.add('hidden');
				}, 300);
			}, 1000);
		}

			// åˆå§‹åŒ–
			document.addEventListener('DOMContentLoaded', async () => {
                
				// æ£€æŸ¥ URL å‚æ•°ä¸­çš„ token
				const urlParams = new URLSearchParams(window.location.search);
				const urlToken = urlParams.get('token');
				if (urlToken) {
					AUTH_TOKEN = urlToken;
					localStorage.setItem('authToken', urlToken);
					// æ¸…ç† URL ä¸­çš„ token å‚æ•°
					const cleanUrl = window.location.origin + window.location.pathname;
					window.history.replaceState({}, document.title, cleanUrl);
				}
                // if (AUTH_TOKEN){
                //     document.getElementById('tokenCard').style.display = 'none';
                // }
				const lang = detectLanguage();
				applyLanguage(lang);
                checkSystemStatus()
				checkKVStatus();

				// ç»‘å®šè¡¨å•äº‹ä»¶
				document.getElementById('regionForm').addEventListener('submit', (e) => {
					e.preventDefault();
					saveConfig({ wk: document.getElementById('wkRegion').value });
				});

				// åè®®ä¿å­˜å‡½æ•°å·²åœ¨HTMLä¸­å®šä¹‰ä¸ºonclick="saveProtocolConfig()"

				document.getElementById('basicConfigForm').addEventListener('submit', (e) => {
					e.preventDefault();
					saveConfig({
						d: document.getElementById('customPath').value,
						p: document.getElementById('customIP').value,
						yx: document.getElementById('yx').value,
						yxURL: document.getElementById('yxURL').value,
						s: document.getElementById('socksConfig').value,
						homepage: document.getElementById('customHomepage').value,
					});
				});

				document.getElementById('advancedConfigForm').addEventListener('submit', (e) => {
					e.preventDefault();
					saveConfig({
						scu: document.getElementById('scu').value,
						epd: document.getElementById('epd').checked ? true : false,
						epi: document.getElementById('epi').checked ? true : false,
						egi: document.getElementById('egi').checked ? true : false,
						ae: document.getElementById('apiEnabled').value,
						rm: document.getElementById('regionMatching').value,
						dkby: document.getElementById('portControl').value,
					});
				});

				// åŠ è½½åŸŸååˆ—è¡¨
				loadDomains();
			});

			// ===== åŸŸåç®¡ç†åŠŸèƒ½ =====

			// åŠ è½½åŸŸååˆ—è¡¨
			async function loadDomains() {
				const tbody = document.getElementById('domainsTbody');
				tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>${t.loading || 'åŠ è½½ä¸­...'}
            </td></tr>`;

				try {
					const res = await authFetch(`${API_BASE}/api/domains`);
					const data = await res.json();

					if (!data.success) {
						tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-sm text-amber-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>${data.error || data.message || 'åŠ è½½å¤±è´¥'}
                    </td></tr>`;
						return;
					}

					let html = '';

					// å†…ç½®åŸŸå
					(data.builtin || []).forEach((d) => {
						const enabled = d.enabled !== false;
						const opacityClass = enabled ? '' : 'opacity-50';
						html += `<tr class="${opacityClass}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${d.domain}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${d.name || d.domain}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">443</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">å†…ç½®</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="toggleBuiltinDomain('${d.domain}', ${!enabled})" 
                                    class="text-indigo-600 hover:text-indigo-900 px-2 py-1 rounded ${enabled ? 'bg-yellow-100 hover:bg-yellow-200' : 'bg-green-100 hover:bg-green-200'} transition-colors">
                                ${enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                        </td>
                    </tr>`;
					});

					// è‡ªå®šä¹‰åŸŸå
					(data.custom || []).forEach((d) => {
						html += `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${d.domain}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${d.name || d.domain}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${d.port || 443}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">è‡ªå®šä¹‰</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="deleteDomain('${d.domain}')" 
                                    class="text-red-600 hover:text-red-900 bg-red-100 hover:bg-red-200 px-2 py-1 rounded transition-colors">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>`;
					});

					if (!html) {
						html = `<tr><td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500">æš‚æ— åŸŸåæ•°æ®</td></tr>`;
					}

					tbody.innerHTML = html;
				} catch (e) {
					tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-sm text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>è¯·æ±‚å¤±è´¥: ${e.message}
                </td></tr>`;
				}
			}

			// æ·»åŠ åŸŸå
			async function addDomain() {
				const domain = document.getElementById('newDomain').value.trim();
				const name = document.getElementById('newDomainName').value.trim();
				const port = parseInt(document.getElementById('newDomainPort').value) || 443;
                const backupArg = document.getElementById('newAddonWsArgs').value.trim();
				if (!domain) {
					showStatus('è¯·è¾“å…¥åŸŸå', 'error');
					return;
				}

				try {
					const res = await authFetch(`${API_BASE}/api/domains`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ domain: domain, name: name || domain, port:port,backupArg:backupArg }),
					});
					const data = await res.json();

					if (data.success) {
						showStatus('åŸŸåæ·»åŠ æˆåŠŸ', 'success');
						document.getElementById('newDomain').value = '';
						document.getElementById('newDomainName').value = '';
                        document.getElementById('newAddonWsArgs').value = '';
						document.getElementById('newDomainPort').value = '443';
						loadDomains();
					} else {
						showStatus(data.error || data.message || 'æ·»åŠ å¤±è´¥', 'error');
					}
				} catch (e) {
					showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
				}
			}

			// åˆ é™¤åŸŸå
			async function deleteDomain(domain) {
				if (!confirm(`ç¡®å®šè¦åˆ é™¤åŸŸå "${domain}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;

				try {
					const res = await authFetch(`${API_BASE}/api/domains`, {
						method: 'DELETE',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ domain }),
					});
					const data = await res.json();

					if (data.success) {
						showStatus('åŸŸååˆ é™¤æˆåŠŸ', 'success');
						loadDomains();
					} else {
						showStatus(data.error || data.message || 'åˆ é™¤å¤±è´¥', 'error');
					}
				} catch (e) {
					showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
				}
			}

			// å¯ç”¨/ç¦ç”¨å†…ç½®åŸŸå
			async function toggleBuiltinDomain(domain, enabled) {
				try {
					const res = await authFetch(`${API_BASE}/api/domains`, {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ domain, enabled }),
					});
					const data = await res.json();

					if (data.success) {
						showStatus(enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨', 'success');
						loadDomains();
					} else {
						showStatus(data.error || data.message || 'æ“ä½œå¤±è´¥', 'error');
					}
				} catch (e) {
					showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
				}
			}

			// æ¸…ç©ºè‡ªå®šä¹‰åŸŸå
			async function clearCustomDomains() {
				if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è‡ªå®šä¹‰åŸŸåå—ï¼Ÿå†…ç½®åŸŸåä¸ä¼šè¢«åˆ é™¤ã€‚')) return;

				try {
					const res = await authFetch(`${API_BASE}/api/domains`, {
						method: 'DELETE',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ all: true }),
					});
					const data = await res.json();

					if (data.success) {
						showStatus(`å·²æ¸…ç©º ${data.deletedCount || 0} ä¸ªè‡ªå®šä¹‰åŸŸå`, 'success');
						loadDomains();
					} else {
						showStatus(data.error || data.message || 'æ¸…ç©ºå¤±è´¥', 'error');
					}
				} catch (e) {
					showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
				}
			}
		</script>
	</body>
</html>
