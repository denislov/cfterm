<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…ä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Courier New", monospace;
            background: #000;
            color: #00ff00;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: -1;
        }

        .matrix-code-rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .matrix-column {
            position: absolute;
            top: -100%;
            color: #00ff00;
            font-size: 14px;
            line-height: 1.2;
            text-shadow: 0 0 5px #00ff00;
            animation: matrix-drop 15s linear infinite;
        }

        @keyframes matrix-drop {
            0% {
                top: -100%;
                opacity: 1;
            }

            90% {
                opacity: 0.3;
            }

            100% {
                top: 100vh;
                opacity: 0;
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 3rem;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #00aa00;
            font-size: 1.1rem;
        }

        .card {
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5), inset 0 0 20px rgba(0, 255, 0, 0.1);
        }

        .card-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin: 15px 0;
        }

        .client-btn {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #00ff00;
            padding: 12px;
            color: #00ff00;
            font-family: "Courier New", monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 5px #00ff00;
        }

        .client-btn:hover {
            background: rgba(0, 255, 0, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 0 20px #00ff00;
        }

        .status-box {
            padding: 15px;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #00ff00;
            margin: 10px 0;
        }

        .status-row {
            margin: 8px 0;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #00ff00;
            font-weight: bold;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .form-input::placeholder {
            color: #00aa00;
            opacity: 0.7;
        }

        .form-hint {
            color: #00aa00;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .btn {
            background: rgba(0, 255, 0, 0.15);
            border: 2px solid #00ff00;
            padding: 12px 24px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: rgba(0, 255, 0, 0.4);
            box-shadow: 0 0 20px #00ff00;
        }

        .btn-danger {
            border-color: #ff4444;
            color: #ff4444;
        }

        .btn-danger:hover {
            background: rgba(255, 0, 0, 0.3);
            box-shadow: 0 0 20px #ff4444;
        }

        .checkbox-group {
            padding: 15px;
            background: rgba(0, 20, 0, 0.6);
            border: 1px solid #00ff00;
        }

        .checkbox-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-item input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .sub-url {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 15px;
            word-break: break-all;
            display: none;
            margin-top: 15px;
        }

        .lang-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .lang-selector select {
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }

        .version-text {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #00ff00;
            opacity: 0.6;
            font-size: 0.8rem;
        }

        .status-msg {
            display: none;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #00ff00;
            background: rgba(0, 20, 0, 0.8);
        }

        .links-section {
            text-align: center;
            margin: 20px 0;
        }

        .links-section a {
            color: #00ff00;
            text-decoration: none;
            margin: 0 20px;
            font-size: 1.1rem;
        }

        .links-section a:hover {
            text-shadow: 0 0 10px #00ff00;
        }

        [dir="rtl"] .form-label {
            text-align: right;
        }

        [dir="rtl"] .btn {
            margin-left: 10px;
            margin-right: 0;
        }
    </style>
</head>

<body>
    <div class="matrix-bg"></div>
    <div class="matrix-code-rain" id="matrixCodeRain"></div>
    <div class="version-text" id="versionText"></div>
    <div class="lang-selector">
        <select id="languageSelector" onchange="changeLanguage(this.value)">
            <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
            <option value="fa">ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ</option>
        </select>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="title" id="pageTitle"></h1>
            <p class="subtitle" id="pageSubtitle"></p>
        </div>

        <!-- å®¢æˆ·ç«¯é€‰æ‹© -->
        <div class="card">
            <h2 class="card-title" id="clientTitle"></h2>
            <div class="client-grid" id="clientGrid"></div>
            <div class="sub-url" id="subUrl"></div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="card">
            <h2 class="card-title" id="statusTitle"></h2>
            <div class="status-box" id="systemStatus">
                <div class="status-row" id="regionStatus"></div>
                <div class="status-row" id="geoInfo"></div>
                <div class="status-row" id="proxyIPStatus"></div>
                <div class="status-row" id="currentIP"></div>
                <div class="status-row" id="echStatus"></div>
                <div class="status-row" id="regionMatch"></div>
            </div>
        </div>

        <!-- Token è¾“å…¥ -->
        <div class="card" id="tokenCard">
            <h2 class="card-title" id="tokenTitle">[ è®¿é—®ä»¤ç‰Œ ]</h2>
            <div class="form-group">
                <label class="form-label" id="tokenLabel">è®¿é—®ä»¤ç‰Œ:</label>
                <input type="password" id="tokenInput" class="form-input" placeholder="è¯·è¾“å…¥ä½ çš„UUIDä»¤ç‰Œ">
                <small class="form-hint" id="tokenHintText">éœ€è¦æœ‰æ•ˆçš„UUIDä»¤ç‰Œæ‰èƒ½è®¿é—®é…ç½®ç®¡ç†åŠŸèƒ½</small>
            </div>
            <button type="button" class="btn" onclick="validateAndSaveToken()" id="tokenSaveBtn">éªŒè¯å¹¶ä¿å­˜</button>
        </div>

        <!-- é…ç½®ç®¡ç† -->
        <div class="card" id="configCard" style="display: none;">
            <h2 class="card-title" id="configTitle"></h2>
            <div id="kvStatus" class="status-box"></div>

            <div id="configContent" style="display: none;">
                <!-- åœ°åŒºé…ç½® -->
                <form id="regionForm">
                    <div class="form-group">
                        <label class="form-label" id="regionLabel"></label>
                        <select id="wkRegion" class="form-select"></select>
                        <small class="form-hint" id="wkRegionHint" style="display:none; color:#ffaa00;"></small>
                    </div>
                    <button type="submit" class="btn" id="saveRegionBtn"></button>
                </form>

                <!-- åè®®é€‰æ‹© -->
                <div class="form-group">
                    <label class="form-label" id="protocolLabel"></label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="ev" checked><span>VLESS</span></label>
                        <label class="checkbox-item"><input type="checkbox" id="et"><span>Trojan</span></label>
                        <label class="checkbox-item"><input type="checkbox" id="ex"><span>xhttp</span></label>
                        <hr style="border-color: rgba(0,255,0,0.3); margin: 15px 0;">
                        <label class="checkbox-item"><input type="checkbox" id="ech"><span>ECH (Encrypted Client
                                Hello)</span></label>
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label" id="trojanPwdLabel"></label>
                            <input type="text" id="tp" class="form-input" placeholder="">
                        </div>
                        <button type="button" class="btn" id="saveProtocolBtn"></button>
                    </div>
                </div>

                <!-- åŸºæœ¬é…ç½® -->
                <form id="basicConfigForm">
                    <div class="form-group">
                        <label class="form-label" id="customPathLabel"></label>
                        <input type="text" id="customPath" class="form-input" placeholder="/mypath">
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="customIPLabel"></label>
                        <input type="text" id="customIP" class="form-input" placeholder="1.2.3.4:443">
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="yxLabel"></label>
                        <input type="text" id="yx" class="form-input" placeholder="1.2.3.4:443#èŠ‚ç‚¹å,5.6.7.8:80">
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="yxURLLabel"></label>
                        <input type="text" id="yxURL" class="form-input" placeholder="">
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="socksLabel"></label>
                        <input type="text" id="socksConfig" class="form-input" placeholder="user:pass@host:port">
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="homepageLabel"></label>
                        <input type="text" id="customHomepage" class="form-input" placeholder="https://example.com">
                        <small class="form-hint" id="homepageHint"></small>
                    </div>
                    <button type="submit" class="btn" id="saveConfigBtn"></button>
                </form>

                <!-- é«˜çº§é…ç½® -->
                <h3 style="color: #00ff00; margin: 25px 0 15px;" id="advancedTitle"></h3>
                <form id="advancedConfigForm">
                    <div class="form-group">
                        <label class="form-label" id="scuLabel"></label>
                        <input type="text" id="scu" class="form-input" placeholder="https://url.v1.mk/sub">
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 15px;">
                        <label class="checkbox-item"><input type="checkbox" id="epd"><span id="epdLabel"></span></label>
                        <label class="checkbox-item"><input type="checkbox" id="epi" checked><span
                                id="epiLabel"></span></label>
                        <label class="checkbox-item"><input type="checkbox" id="egi" checked><span
                                id="egiLabel"></span></label>
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="aeLabel"></label>
                        <select id="apiEnabled" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="rmLabel"></label>
                        <select id="regionMatching" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="dkbyLabel"></label>
                        <select id="portControl" class="form-select"></select>
                    </div>
                    <button type="submit" class="btn" id="saveAdvancedBtn"></button>
                </form>

                <!-- å½“å‰é…ç½®æ˜¾ç¤º -->
                <div id="currentConfig" class="status-box" style="margin-top: 20px;"></div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="loadCurrentConfig()" id="refreshBtn"></button>
                    <button class="btn btn-danger" onclick="resetAllConfig()" id="resetBtn"></button>
                </div>

                <!-- ä¼˜é€‰åŸŸåç®¡ç† -->
                <h3 style="color: #00ff00; margin: 25px 0 15px;" id="domainsTitle">[ ä¼˜é€‰åŸŸåç®¡ç† ]</h3>
                <div class="form-hint" style="margin-bottom: 15px;" id="domainsHint">ç®¡ç†è®¢é˜…ä¸­ä½¿ç”¨çš„ä¼˜é€‰åŸŸååˆ—è¡¨ã€‚éœ€å…ˆå¼€å¯"å…è®¸APIç®¡ç†"é€‰é¡¹ã€‚
                </div>

                <div id="domainsTableContainer" style="margin-bottom: 20px;">
                    <table id="domainsTable" style="width: 100%; border-collapse: collapse; border: 1px solid #00ff00;">
                        <thead>
                            <tr style="background: rgba(0, 255, 0, 0.1);">
                                <th style="border: 1px solid #00ff00; padding: 10px; text-align: left;" id="domainCol">
                                    åŸŸå</th>
                                <th style="border: 1px solid #00ff00; padding: 10px; text-align: left;" id="nameCol">åç§°
                                </th>
                                <th style="border: 1px solid #00ff00; padding: 10px; text-align: center; width: 80px;"
                                    id="portCol">ç«¯å£</th>
                                <th style="border: 1px solid #00ff00; padding: 10px; text-align: center; width: 60px;"
                                    id="typeCol">ç±»å‹</th>
                                <th style="border: 1px solid #00ff00; padding: 10px; text-align: center; width: 80px;"
                                    id="actionCol">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="domainsTbody"></tbody>
                    </table>
                </div>

                <!-- æ·»åŠ æ–°åŸŸå -->
                <div class="form-group"
                    style="background: rgba(0, 20, 0, 0.6); border: 1px solid #00ff00; padding: 15px;">
                    <label class="form-label" id="addDomainLabel">æ·»åŠ æ–°åŸŸå</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="newDomain" class="form-input" style="flex: 2; min-width: 200px;"
                            placeholder="example.com">
                        <input type="text" id="newDomainName" class="form-input" style="flex: 1; min-width: 100px;"
                            placeholder="èŠ‚ç‚¹åç§°">
                        <input type="number" id="newDomainPort" class="form-input" style="width: 80px;"
                            placeholder="443" value="443">
                        <button type="button" class="btn" onclick="addDomain()" id="addDomainBtn">æ·»åŠ </button>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn" onclick="loadDomains()" id="refreshDomainsBtn">åˆ·æ–°åˆ—è¡¨</button>
                    <button class="btn btn-danger" onclick="clearCustomDomains()" id="clearDomainsBtn">æ¸…ç©ºè‡ªå®šä¹‰</button>
                </div>
            </div>
            <div id="statusMessage" class="status-msg"></div>
        </div>

        <!-- ç›¸å…³é“¾æ¥ -->
        <div class="card">
            <h2 class="card-title" id="linksTitle"></h2>
            <div class="links-section">
                <a href="https://github.com/byJoey/cfnew" target="_blank" id="githubLink"></a>
                <a href="https://www.youtube.com/@joeyblog" target="_blank">YouTube @joeyblog</a>
            </div>
        </div>
    </div>

    <script>
        // å¤šè¯­è¨€ç¿»è¯‘é…ç½®
        const i18n = {
            zh: {
                title: 'è®¢é˜…ä¸­å¿ƒ', subtitle: 'å¤šå®¢æˆ·ç«¯æ”¯æŒ â€¢ æ™ºèƒ½ä¼˜é€‰ â€¢ ä¸€é”®ç”Ÿæˆ',
                clientTitle: '[ é€‰æ‹©å®¢æˆ·ç«¯ ]', statusTitle: '[ ç³»ç»ŸçŠ¶æ€ ]',
                configTitle: '[ é…ç½®ç®¡ç† ]', linksTitle: '[ ç›¸å…³é“¾æ¥ ]',
                version: 'ç»ˆç«¯ v2.9.2', githubLink: 'GitHub é¡¹ç›®',
                regionLabel: 'æŒ‡å®šåœ°åŒº (wk):', autoDetect: 'è‡ªåŠ¨æ£€æµ‹',
                saveRegion: 'ä¿å­˜åœ°åŒº', protocolLabel: 'åè®®é€‰æ‹©:',
                trojanPwdLabel: 'Trojan å¯†ç  (å¯é€‰):', saveProtocol: 'ä¿å­˜åè®®',
                customPathLabel: 'è‡ªå®šä¹‰è·¯å¾„ (d):', customIPLabel: 'è‡ªå®šä¹‰ProxyIP (p):',
                yxLabel: 'ä¼˜é€‰IPåˆ—è¡¨ (yx):', yxURLLabel: 'ä¼˜é€‰IPæ¥æºURL:',
                socksLabel: 'SOCKS5é…ç½®:', homepageLabel: 'è‡ªå®šä¹‰é¦–é¡µURL:',
                homepageHint: 'è®¾ç½®è‡ªå®šä¹‰URLä½œä¸ºé¦–é¡µä¼ªè£…',
                saveConfig: 'ä¿å­˜é…ç½®', advancedTitle: 'é«˜çº§æ§åˆ¶',
                scuLabel: 'è®¢é˜…è½¬æ¢åœ°å€:', epdLabel: 'å¯ç”¨ä¼˜é€‰åŸŸå',
                epiLabel: 'å¯ç”¨ä¼˜é€‰IP', egiLabel: 'å¯ç”¨GitHubä¼˜é€‰',
                aeLabel: 'APIç®¡ç†:', aeDefault: 'é»˜è®¤ï¼ˆå…³é—­ï¼‰', aeYes: 'å¼€å¯',
                rmLabel: 'åœ°åŒºåŒ¹é…:', rmDefault: 'é»˜è®¤ï¼ˆå¯ç”¨ï¼‰', rmNo: 'å…³é—­',
                dkbyLabel: 'TLSæ§åˆ¶:', dkbyDefault: 'é»˜è®¤ï¼ˆå…¨éƒ¨ï¼‰', dkbyYes: 'ä»…TLS',
                saveAdvanced: 'ä¿å­˜é«˜çº§é…ç½®', refresh: 'åˆ·æ–°', reset: 'é‡ç½®',
                checking: 'æ£€æµ‹ä¸­...', workerRegion: 'Workeråœ°åŒº: ',
                detectionMethod: 'æ£€æµ‹æ–¹å¼: ', proxyIPStatus: 'ProxyIPçŠ¶æ€: ',
                currentIP: 'å½“å‰ä½¿ç”¨IP: ', regionMatch: 'åœ°åŒºåŒ¹é…: ',
                kvEnabled: 'âœ… KVå­˜å‚¨å·²å¯ç”¨', kvDisabled: 'âš ï¸ KVå­˜å‚¨æœªé…ç½®',
                subCopied: 'è®¢é˜…é“¾æ¥å·²å¤åˆ¶', loading: 'åŠ è½½ä¸­...',
                regions: { US: 'ğŸ‡ºğŸ‡¸ ç¾å›½', SG: 'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡', JP: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬', KR: 'ğŸ‡°ğŸ‡· éŸ©å›½', DE: 'ğŸ‡©ğŸ‡ª å¾·å›½', SE: 'ğŸ‡¸ğŸ‡ª ç‘å…¸', NL: 'ğŸ‡³ğŸ‡± è·å…°', FI: 'ğŸ‡«ğŸ‡® èŠ¬å…°', GB: 'ğŸ‡¬ğŸ‡§ è‹±å›½' },
                cloudflareDetection: 'Cloudflareæ£€æµ‹', available: 'å¯ç”¨', smartSelection: 'æ™ºèƒ½é€‰æ‹©ä¸­',
                tokenLabel: 'è®¿é—®ä»¤ç‰Œ:', tokenPlaceholder: 'è¯·è¾“å…¥ä½ çš„UUIDä»¤ç‰Œ', tokenHint: 'éœ€è¦æœ‰æ•ˆçš„UUIDä»¤ç‰Œæ‰èƒ½è®¿é—®é…ç½®ç®¡ç†åŠŸèƒ½',
                tokenSave: 'éªŒè¯å¹¶ä¿å­˜', tokenRequired: 'è¯·å…ˆè¾“å…¥è®¿é—®ä»¤ç‰Œ', tokenInvalid: 'ä»¤ç‰ŒéªŒè¯å¤±è´¥'
            },
            fa: {
                title: 'Ù…Ø±Ú©Ø² Ø§Ø´ØªØ±Ø§Ú©', subtitle: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú†Ù†Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª â€¢ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯',
                clientTitle: '[ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§ÛŒÙ†Øª ]', statusTitle: '[ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ… ]',
                configTitle: '[ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª ]', linksTitle: '[ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ ]',
                version: 'ØªØ±Ù…ÛŒÙ†Ø§Ù„ v2.9.2', githubLink: 'Ù¾Ø±ÙˆÚ˜Ù‡ GitHub',
                regionLabel: 'ØªØ¹ÛŒÛŒÙ† Ù…Ù†Ø·Ù‚Ù‡:', autoDetect: 'ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±',
                saveRegion: 'Ø°Ø®ÛŒØ±Ù‡', protocolLabel: 'Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆØªÚ©Ù„:',
                trojanPwdLabel: 'Ø±Ù…Ø² Trojan:', saveProtocol: 'Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆØªÚ©Ù„',
                customPathLabel: 'Ù…Ø³ÛŒØ± Ø³ÙØ§Ø±Ø´ÛŒ:', customIPLabel: 'ProxyIP Ø³ÙØ§Ø±Ø´ÛŒ:',
                yxLabel: 'Ù„ÛŒØ³Øª IP ØªØ±Ø¬ÛŒØ­ÛŒ:', yxURLLabel: 'URL Ù…Ù†Ø¨Ø¹ IP:',
                socksLabel: 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª SOCKS5:', homepageLabel: 'URL ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ:',
                homepageHint: 'ØªÙ†Ø¸ÛŒÙ… URL Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØªØ§Ø±',
                saveConfig: 'Ø°Ø®ÛŒØ±Ù‡', advancedTitle: 'Ú©Ù†ØªØ±Ù„ Ù¾ÛŒØ´Ø±ÙØªÙ‡',
                scuLabel: 'Ø¢Ø¯Ø±Ø³ ØªØ¨Ø¯ÛŒÙ„:', epdLabel: 'Ø¯Ø§Ù…Ù†Ù‡ ØªØ±Ø¬ÛŒØ­ÛŒ',
                epiLabel: 'IP ØªØ±Ø¬ÛŒØ­ÛŒ', egiLabel: 'GitHub ØªØ±Ø¬ÛŒØ­ÛŒ',
                aeLabel: 'Ù…Ø¯ÛŒØ±ÛŒØª API:', aeDefault: 'Ù¾ÛŒØ´â€ŒÙØ±Ø¶', aeYes: 'ÙØ¹Ø§Ù„',
                rmLabel: 'ØªØ·Ø¨ÛŒÙ‚ Ù…Ù†Ø·Ù‚Ù‡:', rmDefault: 'Ù¾ÛŒØ´â€ŒÙØ±Ø¶', rmNo: 'ØºÛŒØ±ÙØ¹Ø§Ù„',
                dkbyLabel: 'Ú©Ù†ØªØ±Ù„ TLS:', dkbyDefault: 'Ù‡Ù…Ù‡', dkbyYes: 'ÙÙ‚Ø· TLS',
                saveAdvanced: 'Ø°Ø®ÛŒØ±Ù‡', refresh: 'ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ', reset: 'Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ',
                checking: 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...', workerRegion: 'Ù…Ù†Ø·Ù‚Ù‡: ',
                detectionMethod: 'Ø±ÙˆØ´: ', proxyIPStatus: 'ÙˆØ¶Ø¹ÛŒØª ProxyIP: ',
                currentIP: 'IP ÙØ¹Ù„ÛŒ: ', regionMatch: 'ØªØ·Ø¨ÛŒÙ‚: ',
                kvEnabled: 'âœ… KV ÙØ¹Ø§Ù„', kvDisabled: 'âš ï¸ KV ØºÛŒØ±ÙØ¹Ø§Ù„',
                subCopied: 'Ú©Ù¾ÛŒ Ø´Ø¯', loading: 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...',
                regions: { US: 'ğŸ‡ºğŸ‡¸ Ø¢Ù…Ø±ÛŒÚ©Ø§', SG: 'ğŸ‡¸ğŸ‡¬ Ø³Ù†Ú¯Ø§Ù¾ÙˆØ±', JP: 'ğŸ‡¯ğŸ‡µ Ú˜Ø§Ù¾Ù†', KR: 'ğŸ‡°ğŸ‡· Ú©Ø±Ù‡', DE: 'ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù†', SE: 'ğŸ‡¸ğŸ‡ª Ø³ÙˆØ¦Ø¯', NL: 'ğŸ‡³ğŸ‡± Ù‡Ù„Ù†Ø¯', FI: 'ğŸ‡«ğŸ‡® ÙÙ†Ù„Ø§Ù†Ø¯', GB: 'ğŸ‡¬ğŸ‡§ Ø¨Ø±ÛŒØªØ§Ù†ÛŒØ§' },
                cloudflareDetection: 'ØªØ´Ø®ÛŒØµ Cloudflare', available: 'Ø¯Ø± Ø¯Ø³ØªØ±Ø³', smartSelection: 'Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯',
                tokenLabel: 'ØªÙˆÚ©Ù† Ø¯Ø³ØªØ±Ø³ÛŒ:', tokenPlaceholder: 'ØªÙˆÚ©Ù† UUID Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', tokenHint: 'Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ ØªÙˆÚ©Ù† UUID Ù…Ø¹ØªØ¨Ø± Ù„Ø§Ø²Ù… Ø§Ø³Øª',
                tokenSave: 'ØªØ£ÛŒÛŒØ¯', tokenRequired: 'Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', tokenInvalid: 'ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª'
            }
        };

        const clients = [
            { type: 'clash', name: 'CLASH', scheme: 'clash://install-config?url=' },
            { type: 'clash', name: 'STASH', scheme: 'stash://install?url=' },
            { type: 'surge', name: 'SURGE', scheme: 'surge:///install-config?url=' },
            { type: 'singbox', name: 'SING-BOX', scheme: 'sing-box://install-config?url=' },
            { type: 'loon', name: 'LOON', scheme: 'loon://install?url=' },
            { type: 'quanx', name: 'QUANTUMULT X', scheme: 'quantumult-x://install-config?url=' },
            { type: 'v2ray', name: 'V2RAY', scheme: '' },
            { type: 'v2ray', name: 'Shadowrocket', scheme: 'shadowrocket://add/' }
        ];

        let currentLang = 'zh';
        let t = i18n.zh;
        const API_BASE = window.location.region;
        const SUB_CONVERTER = 'https://url.v1.mk/sub';

        // Token ç®¡ç†
        let AUTH_TOKEN = localStorage.getItem('authToken') || '';

        // å¸¦è®¤è¯çš„ fetch å°è£…
        async function authFetch(url, options = {}) {
            const headers = {
                ...options.headers,
            };
            if (AUTH_TOKEN) {
                headers['X-Token'] = AUTH_TOKEN;
            }
            return fetch(url, { ...options, headers });
        }

        // éªŒè¯å¹¶ä¿å­˜ Token
        async function validateAndSaveToken() {
            const tokenInput = document.getElementById('tokenInput');
            const token = tokenInput.value.trim();

            if (!token) {
                showStatus(t.tokenRequired, 'error');
                return;
            }

            // ä¸´æ—¶è®¾ç½® token å¹¶æµ‹è¯•
            AUTH_TOKEN = token;
            try {
                const res = await authFetch(`${API_BASE}/api/config`);
                if (res.ok || res.status === 503) {
                    // 503 è¡¨ç¤º KV æœªé…ç½®ï¼Œä½†è®¤è¯æˆåŠŸ
                    localStorage.setItem('authToken', token);
                    showStatus('Token éªŒè¯æˆåŠŸ', 'success');
                    document.getElementById('tokenCard').style.display = 'none';
                    checkKVStatus();
                    loadDomains();
                } else if (res.status === 401 || res.status === 403) {
                    AUTH_TOKEN = '';
                    showStatus(t.tokenInvalid, 'error');
                } else {
                    const data = await res.json();
                    showStatus(data.error || t.tokenInvalid, 'error');
                }
            } catch (e) {
                AUTH_TOKEN = '';
                showStatus('éªŒè¯å¤±è´¥: ' + e.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function getCookie(name) {
            const v = '; ' + document.cookie;
            const p = v.split('; ' + name + '=');
            return p.length === 2 ? p.pop().split(';').shift() : null;
        }
        function setCookie(name, value) {
            const d = new Date(); d.setFullYear(d.getFullYear() + 1);
            document.cookie = `${name}=${value}; path=/; expires=${d.toUTCString()}; SameSite=Lax`;
        }
        function detectLanguage() {
            const saved = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
            if (saved === 'fa' || saved === 'fa-IR') return 'fa';
            if (saved === 'zh' || saved === 'zh-CN') return 'zh';
            return navigator.language?.includes('fa') ? 'fa' : 'zh';
        }
        function changeLanguage(lang) {
            localStorage.setItem('preferredLanguage', lang);
            setCookie('preferredLanguage', lang);
            location.reload();
        }

        // åº”ç”¨è¯­è¨€
        function applyLanguage(lang) {
            currentLang = lang;
            t = i18n[lang];
            document.documentElement.lang = lang === 'fa' ? 'fa-IR' : 'zh-CN';
            document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
            document.title = t.title;

            // æ›´æ–°UIæ–‡æœ¬
            document.getElementById('versionText').textContent = t.version;
            document.getElementById('pageTitle').textContent = t.title;
            document.getElementById('pageSubtitle').textContent = t.subtitle;
            document.getElementById('clientTitle').textContent = t.clientTitle;
            document.getElementById('statusTitle').textContent = t.statusTitle;
            document.getElementById('configTitle').textContent = t.configTitle;
            document.getElementById('linksTitle').textContent = t.linksTitle;
            document.getElementById('githubLink').textContent = t.githubLink;
            document.getElementById('regionLabel').textContent = t.regionLabel;
            document.getElementById('saveRegionBtn').textContent = t.saveRegion;
            document.getElementById('protocolLabel').textContent = t.protocolLabel;
            document.getElementById('trojanPwdLabel').textContent = t.trojanPwdLabel;
            document.getElementById('saveProtocolBtn').textContent = t.saveProtocol;
            document.getElementById('customPathLabel').textContent = t.customPathLabel;
            document.getElementById('customIPLabel').textContent = t.customIPLabel;
            document.getElementById('yxLabel').textContent = t.yxLabel;
            document.getElementById('yxURLLabel').textContent = t.yxURLLabel;
            document.getElementById('socksLabel').textContent = t.socksLabel;
            document.getElementById('homepageLabel').textContent = t.homepageLabel;
            document.getElementById('homepageHint').textContent = t.homepageHint;
            document.getElementById('saveConfigBtn').textContent = t.saveConfig;
            document.getElementById('advancedTitle').textContent = t.advancedTitle;
            document.getElementById('scuLabel').textContent = t.scuLabel;
            document.getElementById('epdLabel').textContent = t.epdLabel;
            document.getElementById('epiLabel').textContent = t.epiLabel;
            document.getElementById('egiLabel').textContent = t.egiLabel;
            document.getElementById('aeLabel').textContent = t.aeLabel;
            document.getElementById('rmLabel').textContent = t.rmLabel;
            document.getElementById('dkbyLabel').textContent = t.dkbyLabel;
            document.getElementById('saveAdvancedBtn').textContent = t.saveAdvanced;
            document.getElementById('refreshBtn').textContent = t.refresh;
            document.getElementById('resetBtn').textContent = t.reset;
            document.getElementById('languageSelector').value = lang;

            // æ¸²æŸ“å®¢æˆ·ç«¯æŒ‰é’®
            renderClientButtons();
            // æ¸²æŸ“åœ°åŒºé€‰æ‹©
            renderRegionSelect();
            // æ¸²æŸ“é«˜çº§é€‰æ‹©æ¡†
            renderAdvancedSelects();
        }

        function renderClientButtons() {
            const grid = document.getElementById('clientGrid');
            grid.innerHTML = clients.map(c =>
                `<button class="client-btn" onclick="generateLink('${c.type}','${c.name}','${c.scheme}')">${c.name}</button>`
            ).join('');
        }

        function renderRegionSelect() {
            const sel = document.getElementById('wkRegion');
            sel.innerHTML = `<option value="">${t.autoDetect}</option>` +
                Object.entries(t.regions).map(([k, v]) => `<option value="${k}">${v}</option>`).join('');
        }

        function renderAdvancedSelects() {
            document.getElementById('apiEnabled').innerHTML = `<option value="">${t.aeDefault}</option><option value="yes">${t.aeYes}</option>`;
            document.getElementById('regionMatching').innerHTML = `<option value="">${t.rmDefault}</option><option value="no">${t.rmNo}</option>`;
            document.getElementById('portControl').innerHTML = `<option value="">${t.dkbyDefault}</option><option value="yes">${t.dkbyYes}</option>`;
        }

        // ç”Ÿæˆè®¢é˜…é“¾æ¥
        function generateLink(type, name, scheme) {
            const subUrl = location.href.replace(/\/$/, '') + '/sub';
            let finalUrl = subUrl;

            if (type !== 'v2ray') {
                const encoded = encodeURIComponent(subUrl);
                finalUrl = `${SUB_CONVERTER}?target=${type}&url=${encoded}&insert=false&emoji=true&list=false&expand=true&scv=false&new_name=true`;
            }

            const urlEl = document.getElementById('subUrl');
            urlEl.textContent = finalUrl;
            urlEl.style.display = 'block';

            if (scheme) {
                const schemeUrl = scheme + encodeURIComponent(finalUrl);
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = schemeUrl;
                document.body.appendChild(iframe);
                setTimeout(() => iframe.remove(), 2000);
            }

            navigator.clipboard.writeText(finalUrl).then(() => {
                showStatus(`${name} ${t.subCopied}`, 'success');
            });
        }

        // çŠ¶æ€æ£€æµ‹
        async function checkSystemStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/status`);
                const data = await res.json();

                document.getElementById('regionStatus').innerHTML = `${t.workerRegion}<span style="color:#44ff44">${t.regions[data.region] || data.region}</span>`;
                document.getElementById('geoInfo').innerHTML = `${t.detectionMethod}<span style="color:#44ff44">${t.cloudflareDetection}</span>`;
                document.getElementById('proxyIPStatus').innerHTML = `${t.proxyIPStatus}<span style="color:#44ff44">âœ… ${t.available}</span>`;
                document.getElementById('currentIP').innerHTML = `${t.currentIP}<span style="color:#44ff44">${t.smartSelection}</span>`;
                document.getElementById('regionMatch').innerHTML = `${t.regionMatch}<span style="color:#44ff44">âœ…</span>`;

                if (data.echEnabled) {
                    document.getElementById('echStatus').innerHTML = `ECH: <span style="color:#44ff44">âœ… ${t.available}</span>`;
                } else {
                    document.getElementById('echStatus').innerHTML = `ECH: <span style="color:#ffaa00">âš ï¸</span>`;
                }
            } catch (e) {
                // å›é€€åˆ°regionç«¯ç‚¹
                try {
                    const res = await fetch(`${API_BASE}/region`);
                    const data = await res.json();
                    document.getElementById('regionStatus').innerHTML = `${t.workerRegion}<span style="color:#44ff44">${t.regions[data.region] || data.region}</span>`;
                    document.getElementById('geoInfo').innerHTML = `${t.detectionMethod}<span style="color:#44ff44">${data.detectionMethod || t.cloudflareDetection}</span>`;
                } catch (e2) {
                    document.getElementById('regionStatus').innerHTML = `${t.workerRegion}<span style="color:#ff4444">âŒ</span>`;
                }
            }
        }

        // KVé…ç½®æ£€æµ‹
        async function checkKVStatus() {
            // å¦‚æœæ²¡æœ‰ tokenï¼Œæ˜¾ç¤º token è¾“å…¥å¡ç‰‡
            if (!AUTH_TOKEN) {
                document.getElementById('tokenCard').style.display = 'block';
                document.getElementById('configCard').style.display = 'none';
                return;
            }

            try {
                const res = await authFetch(`${API_BASE}/api/config`);

                // è®¤è¯å¤±è´¥
                if (res.status === 401 || res.status === 403) {
                    AUTH_TOKEN = '';
                    localStorage.removeItem('authToken');
                    document.getElementById('tokenCard').style.display = 'block';
                    document.getElementById('configCard').style.display = 'none';
                    return;
                }

                // éšè— token å¡ç‰‡
                document.getElementById('tokenCard').style.display = 'none';

                if (res.status === 503) {
                    document.getElementById('kvStatus').innerHTML = `<span style="color:#ffaa00">${t.kvDisabled}</span>`;
                    document.getElementById('configCard').style.display = 'block';
                    return;
                }
                const data = await res.json();
                if (data.kvEnabled) {
                    document.getElementById('kvStatus').innerHTML = `<span style="color:#44ff44">${t.kvEnabled}</span>`;
                    document.getElementById('configContent').style.display = 'block';
                    document.getElementById('configCard').style.display = 'block';
                    loadCurrentConfig();
                } else {
                    document.getElementById('kvStatus').innerHTML = `<span style="color:#ffaa00">${t.kvDisabled}</span>`;
                    document.getElementById('configCard').style.display = 'block';
                }
            } catch (e) {
                document.getElementById('kvStatus').innerHTML = `<span style="color:#ffaa00">${t.kvDisabled}</span>`;
                document.getElementById('configCard').style.display = 'block';
            }
        }

        // åŠ è½½å½“å‰é…ç½®
        async function loadCurrentConfig() {
            try {
                const res = await authFetch(`${API_BASE}/api/config`);
                if (!res.ok) return;
                const cfg = await res.json();

                // å¡«å……è¡¨å•
                document.getElementById('wkRegion').value = cfg.wk || '';
                document.getElementById('ev').checked = cfg.ev !== 'no';
                document.getElementById('et').checked = cfg.et === 'yes';
                document.getElementById('ex').checked = cfg.ex === 'yes';
                document.getElementById('ech').checked = cfg.ech === 'yes';
                document.getElementById('tp').value = cfg.tp || '';
                document.getElementById('customPath').value = cfg.d || '';
                document.getElementById('customIP').value = cfg.p || '';
                document.getElementById('yx').value = cfg.yx || '';
                document.getElementById('yxURL').value = cfg.yxURL || '';
                document.getElementById('socksConfig').value = cfg.s || '';
                document.getElementById('customHomepage').value = cfg.homepage || '';
                document.getElementById('scu').value = cfg.scu || '';
                document.getElementById('epd').checked = cfg.epd === 'yes';
                document.getElementById('epi').checked = cfg.epi !== 'no';
                document.getElementById('egi').checked = cfg.egi !== 'no';
                document.getElementById('apiEnabled').value = cfg.ae || '';
                document.getElementById('regionMatching').value = cfg.rm || '';
                document.getElementById('portControl').value = cfg.dkby || '';

                // æ˜¾ç¤ºå½“å‰é…ç½®
                const display = Object.entries(cfg).filter(([k]) => k !== 'kvEnabled').map(([k, v]) => `${k}: ${v || '(ç©º)'}`).join('\n');
                document.getElementById('currentConfig').textContent = display || '(æ— é…ç½®)';
            } catch (e) {
                document.getElementById('currentConfig').textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig(data) {
            try {
                const res = await authFetch(`${API_BASE}/api/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                showStatus(result.message || 'ä¿å­˜æˆåŠŸ', result.success ? 'success' : 'error');
                if (result.success) {
                    loadCurrentConfig();
                    setTimeout(() => location.reload(), 1500);
                }
            } catch (e) {
                showStatus('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }

        // é‡ç½®é…ç½®
        async function resetAllConfig() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ')) return;
            await saveConfig({ wk: '', d: '', p: '', yx: '', yxURL: '', s: '', ae: '', rm: '', dkby: '', ev: '', et: '', ex: '', tp: '', scu: '', epd: '', epi: '', egi: '', homepage: '' });
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.style.display = 'block';
            el.style.color = type === 'success' ? '#00ff00' : '#ff4444';
            el.style.borderColor = type === 'success' ? '#00ff00' : '#ff4444';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // Matrixé›¨æ•ˆæœ
        function createMatrixRain() {
            const container = document.getElementById('matrixCodeRain');
            const chars = '01ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const cols = Math.floor(window.innerWidth / 20);
            for (let i = 0; i < cols; i++) {
                const col = document.createElement('div');
                col.className = 'matrix-column';
                col.style.left = (i * 20) + 'px';
                col.style.animationDelay = (Math.random() * 15) + 's';
                col.style.animationDuration = (Math.random() * 10 + 10) + 's';
                let text = '';
                for (let j = 0; j < 30; j++) {
                    text += chars[Math.floor(Math.random() * chars.length)] + '<br>';
                }
                col.innerHTML = text;
                container.appendChild(col);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const lang = detectLanguage();
            applyLanguage(lang);
            createMatrixRain();
            checkSystemStatus();
            checkKVStatus();

            // ç»‘å®šè¡¨å•äº‹ä»¶
            document.getElementById('regionForm').addEventListener('submit', e => {
                e.preventDefault();
                saveConfig({ wk: document.getElementById('wkRegion').value });
            });

            document.getElementById('saveProtocolBtn').addEventListener('click', () => {
                saveConfig({
                    ev: document.getElementById('ev').checked ? 'yes' : 'no',
                    et: document.getElementById('et').checked ? 'yes' : 'no',
                    ex: document.getElementById('ex').checked ? 'yes' : 'no',
                    ech: document.getElementById('ech').checked ? 'yes' : 'no',
                    tp: document.getElementById('tp').value
                });
            });

            document.getElementById('basicConfigForm').addEventListener('submit', e => {
                e.preventDefault();
                saveConfig({
                    d: document.getElementById('customPath').value,
                    p: document.getElementById('customIP').value,
                    yx: document.getElementById('yx').value,
                    yxURL: document.getElementById('yxURL').value,
                    s: document.getElementById('socksConfig').value,
                    homepage: document.getElementById('customHomepage').value
                });
            });

            document.getElementById('advancedConfigForm').addEventListener('submit', e => {
                e.preventDefault();
                saveConfig({
                    scu: document.getElementById('scu').value,
                    epd: document.getElementById('epd').checked ? 'yes' : 'no',
                    epi: document.getElementById('epi').checked ? 'yes' : 'no',
                    egi: document.getElementById('egi').checked ? 'yes' : 'no',
                    ae: document.getElementById('apiEnabled').value,
                    rm: document.getElementById('regionMatching').value,
                    dkby: document.getElementById('portControl').value
                });
            });

            // åŠ è½½åŸŸååˆ—è¡¨
            loadDomains();
        });

        // ===== åŸŸåç®¡ç†åŠŸèƒ½ =====

        // åŠ è½½åŸŸååˆ—è¡¨
        async function loadDomains() {
            const tbody = document.getElementById('domainsTbody');
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; border: 1px solid #00ff00; color: #00aa00;">${t.loading || 'åŠ è½½ä¸­...'}</td></tr>`;

            try {
                const res = await authFetch(`${API_BASE}/api/domains`);
                const data = await res.json();

                if (!data.success) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; border: 1px solid #00ff00; color: #ffaa00;">${data.error || data.message || 'åŠ è½½å¤±è´¥'}</td></tr>`;
                    return;
                }

                let html = '';

                // å†…ç½®åŸŸå
                (data.builtin || []).forEach(d => {
                    const enabled = d.enabled !== false;
                    const style = enabled ? '' : 'opacity: 0.5;';
                    html += `<tr style="${style}">
                        <td style="border: 1px solid #00ff00; padding: 8px;">${d.domain}</td>
                        <td style="border: 1px solid #00ff00; padding: 8px;">${d.name || d.domain}</td>
                        <td style="border: 1px solid #00ff00; padding: 8px; text-align: center;">443</td>
                        <td style="border: 1px solid #00ff00; padding: 8px; text-align: center; color: #00aa00;">å†…ç½®</td>
                        <td style="border: 1px solid #00ff00; padding: 8px; text-align: center;">
                            <button class="btn" style="padding: 5px 10px; margin: 0; font-size: 12px;" 
                                onclick="toggleBuiltinDomain('${d.domain}', ${!enabled})">${enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        </td>
                    </tr>`;
                });

                // è‡ªå®šä¹‰åŸŸå
                (data.custom || []).forEach(d => {
                    html += `<tr>
                        <td style="border: 1px solid #00ff00; padding: 8px;">${d.domain}</td>
                        <td style="border: 1px solid #00ff00; padding: 8px;">${d.name || d.domain}</td>
                        <td style="border: 1px solid #00ff00; padding: 8px; text-align: center;">${d.port || 443}</td>
                        <td style="border: 1px solid #00ff00; padding: 8px; text-align: center; color: #44ff44;">è‡ªå®šä¹‰</td>
                        <td style="border: 1px solid #00ff00; padding: 8px; text-align: center;">
                            <button class="btn btn-danger" style="padding: 5px 10px; margin: 0; font-size: 12px;" 
                                onclick="deleteDomain('${d.domain}')">åˆ é™¤</button>
                        </td>
                    </tr>`;
                });

                if (!html) {
                    html = `<tr><td colspan="5" style="text-align: center; padding: 20px; border: 1px solid #00ff00; color: #00aa00;">æš‚æ— åŸŸåæ•°æ®</td></tr>`;
                }

                tbody.innerHTML = html;
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; border: 1px solid #00ff00; color: #ff4444;">è¯·æ±‚å¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        // æ·»åŠ åŸŸå
        async function addDomain() {
            const domain = document.getElementById('newDomain').value.trim();
            const name = document.getElementById('newDomainName').value.trim();
            const port = parseInt(document.getElementById('newDomainPort').value) || 443;

            if (!domain) {
                showStatus('è¯·è¾“å…¥åŸŸå', 'error');
                return;
            }

            try {
                const res = await authFetch(`${API_BASE}/api/domains`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, name: name || domain, port })
                });
                const data = await res.json();

                if (data.success) {
                    showStatus('åŸŸåæ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('newDomain').value = '';
                    document.getElementById('newDomainName').value = '';
                    document.getElementById('newDomainPort').value = '443';
                    loadDomains();
                } else {
                    showStatus(data.error || data.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (e) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }

        // åˆ é™¤åŸŸå
        async function deleteDomain(domain) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åŸŸå "${domain}" å—ï¼Ÿ`)) return;

            try {
                const res = await authFetch(`${API_BASE}/api/domains`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });
                const data = await res.json();

                if (data.success) {
                    showStatus('åŸŸååˆ é™¤æˆåŠŸ', 'success');
                    loadDomains();
                } else {
                    showStatus(data.error || data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }

        // å¯ç”¨/ç¦ç”¨å†…ç½®åŸŸå
        async function toggleBuiltinDomain(domain, enabled) {
            try {
                const res = await authFetch(`${API_BASE}/api/domains`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, enabled })
                });
                const data = await res.json();

                if (data.success) {
                    showStatus(enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨', 'success');
                    loadDomains();
                } else {
                    showStatus(data.error || data.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (e) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }

        // æ¸…ç©ºè‡ªå®šä¹‰åŸŸå
        async function clearCustomDomains() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è‡ªå®šä¹‰åŸŸåå—ï¼Ÿå†…ç½®åŸŸåä¸ä¼šè¢«åˆ é™¤ã€‚')) return;

            try {
                const res = await authFetch(`${API_BASE}/api/domains`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ all: true })
                });
                const data = await res.json();

                if (data.success) {
                    showStatus(`å·²æ¸…ç©º ${data.deletedCount || 0} ä¸ªè‡ªå®šä¹‰åŸŸå`, 'success');
                    loadDomains();
                } else {
                    showStatus(data.error || data.message || 'æ¸…ç©ºå¤±è´¥', 'error');
                }
            } catch (e) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }
    </script>
</body>

</html>